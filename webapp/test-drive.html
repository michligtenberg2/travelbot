<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ TravelBot Test Mode</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .coordinates {
            font-family: monospace;
            background: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ TravelBot GPS & API Test Mode</h1>
    <p>Test alle functionaliteiten voordat je gaat rijden!</p>

    <div class="test-section">
        <h3>üìç GPS Test</h3>
        <button class="test-button" onclick="testGPS()">Test GPS Toegang</button>
        <button class="test-button" onclick="startTracking()">Start Live Tracking</button>
        <button class="test-button" onclick="stopTracking()">Stop Tracking</button>
        <div id="gps-status"></div>
        <div id="location-display"></div>
    </div>

    <div class="test-section">
        <h3>ü§ñ API Test</h3>
        <select id="persona-select">
            <option value="Jordanees">Heino (Jordanees)</option>
            <option value="Belg">Neerslachtige Belg</option>
            <option value="SergioHerman">Sergio Herman</option>
        </select>
        <button class="test-button" onclick="testAPI()">Test API Call</button>
        <div id="api-status"></div>
        <div id="api-response"></div>
    </div>

    <div class="test-section">
        <h3>üó£Ô∏è Speech Test</h3>
        <button class="test-button" onclick="testTTS()">Test Text-to-Speech</button>
        <div id="tts-status"></div>
    </div>

    <div class="test-section">
        <h3>üåê Connectivity Test</h3>
        <button class="test-button" onclick="testConnectivity()">Test Internet & Backend</button>
        <div id="connectivity-status"></div>
    </div>

    <div class="test-section">
        <h3>üì± Safari Compatibility</h3>
        <button class="test-button" onclick="testSafari()">Test Safari Features</button>
        <div id="safari-status"></div>
    </div>

    <script>
        let locationManager;
        let ttsManager;
        let travelbotEngine;
        let watchId;

        // Initialize managers
        function initManagers() {
            if (typeof LocationManager !== 'undefined') {
                locationManager = new LocationManager();
            }
            if (typeof TtsManager !== 'undefined') {
                ttsManager = new TtsManager();
            }
            if (typeof TravelBotEngine !== 'undefined') {
                travelbotEngine = new TravelBotEngine('https://travelbot-2k7x.onrender.com');
            }
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function testGPS() {
            showStatus('gps-status', 'üîç Testing GPS access...', 'info');
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation not supported');
                }

                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    throw new Error('HTTPS required for GPS (except localhost)');
                }

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const coords = position.coords;
                showStatus('gps-status', '‚úÖ GPS werkt perfect!', 'success');
                document.getElementById('location-display').innerHTML = `
                    <div class="coordinates">
                        üìç Lat: ${coords.latitude.toFixed(6)}<br>
                        üìç Lon: ${coords.longitude.toFixed(6)}<br>
                        üéØ Accuracy: ${coords.accuracy}m<br>
                        ‚è∞ Timestamp: ${new Date(position.timestamp).toLocaleTimeString()}
                    </div>
                `;
            } catch (error) {
                showStatus('gps-status', `‚ùå GPS Error: ${error.message}`, 'error');
            }
        }

        async function startTracking() {
            if (!navigator.geolocation) {
                showStatus('gps-status', '‚ùå GPS niet beschikbaar', 'error');
                return;
            }

            showStatus('gps-status', 'üöÄ Starting live tracking...', 'info');
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const coords = position.coords;
                    showStatus('gps-status', 'üîÑ Live tracking actief', 'success');
                    document.getElementById('location-display').innerHTML = `
                        <div class="coordinates">
                            üìç Live: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}<br>
                            üéØ Nauwkeurigheid: ${coords.accuracy}m<br>
                            üïê Update: ${new Date().toLocaleTimeString()}
                        </div>
                    `;
                },
                (error) => {
                    showStatus('gps-status', `‚ùå Tracking error: ${error.message}`, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                showStatus('gps-status', '‚èπÔ∏è Tracking gestopt', 'info');
            }
        }

        async function testAPI() {
            showStatus('api-status', 'ü§ñ Testing API connection...', 'info');
            
            try {
                // Test coordinates van Kapelaan Kockstraat 56, Steenbergen
                const lat = 51.5861;
                const lon = 4.3178;
                const persona = document.getElementById('persona-select').value;

                const response = await fetch('https://travelbot-2k7x.onrender.com/comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: lat,
                        lon: lon,
                        persona: persona
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                showStatus('api-status', '‚úÖ API werkt perfect!', 'success');
                document.getElementById('api-response').innerHTML = `
                    <div class="status success">
                        <strong>üé≠ ${persona} Response:</strong><br>
                        "${data.text}"
                    </div>
                `;

            } catch (error) {
                showStatus('api-status', `‚ùå API Error: ${error.message}`, 'error');
            }
        }

        function testTTS() {
            if (!('speechSynthesis' in window)) {
                showStatus('tts-status', '‚ùå Text-to-Speech niet beschikbaar', 'error');
                return;
            }

            showStatus('tts-status', 'üó£Ô∏è Testing Text-to-Speech...', 'info');

            const utterance = new SpeechSynthesisUtterance('Hallo! Dit is een test van de text-to-speech functionaliteit. Als je dit hoort, dan werkt alles perfect!');
            utterance.lang = 'nl-NL';
            utterance.rate = 0.9;
            utterance.pitch = 1.0;

            utterance.onstart = () => {
                showStatus('tts-status', 'üîä Speech test gestart', 'info');
            };

            utterance.onend = () => {
                showStatus('tts-status', '‚úÖ Text-to-Speech werkt!', 'success');
            };

            utterance.onerror = (error) => {
                showStatus('tts-status', `‚ùå TTS Error: ${error.error}`, 'error');
            };

            speechSynthesis.speak(utterance);
        }

        async function testConnectivity() {
            showStatus('connectivity-status', 'üåê Testing connectivity...', 'info');
            
            try {
                // Test internet
                const internetResponse = await fetch('https://httpbin.org/ip', { 
                    method: 'GET',
                    cache: 'no-cache' 
                });
                
                if (!internetResponse.ok) {
                    throw new Error('No internet connection');
                }

                // Test backend
                const backendResponse = await fetch('https://travelbot-2k7x.onrender.com/health');
                
                if (!backendResponse.ok) {
                    throw new Error(`Backend unreachable: ${backendResponse.status}`);
                }

                const health = await backendResponse.json();
                
                showStatus('connectivity-status', `‚úÖ All systems go!<br>
                    üåê Internet: Connected<br>
                    ü§ñ Backend: ${health.status}<br>
                    üìä Backend Time: ${health.timestamp}`, 'success');

            } catch (error) {
                showStatus('connectivity-status', `‚ùå Connectivity Error: ${error.message}`, 'error');
            }
        }

        function testSafari() {
            showStatus('safari-status', 'üß≠ Testing Safari compatibility...', 'info');
            
            const tests = [];

            // Check if Safari
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            tests.push(`üåê Safari: ${isSafari ? '‚úÖ Detected' : '‚ùå Not Safari'}`);

            // Check secure context
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            tests.push(`üîí Secure Context: ${isSecure ? '‚úÖ HTTPS/localhost' : '‚ùå HTTP'}`);

            // Check geolocation
            const hasGeo = 'geolocation' in navigator;
            tests.push(`üìç Geolocation API: ${hasGeo ? '‚úÖ Available' : '‚ùå Not supported'}`);

            // Check speech synthesis
            const hasSpeech = 'speechSynthesis' in window;
            tests.push(`üó£Ô∏è Speech Synthesis: ${hasSpeech ? '‚úÖ Available' : '‚ùå Not supported'}`);

            // Check service worker
            const hasServiceWorker = 'serviceWorker' in navigator;
            tests.push(`‚öôÔ∏è Service Worker: ${hasServiceWorker ? '‚úÖ Available' : '‚ùå Not supported'}`);

            const allGood = tests.every(test => test.includes('‚úÖ'));
            
            showStatus('safari-status', `${allGood ? '‚úÖ' : '‚ö†Ô∏è'} Safari Compatibility Check:<br>${tests.join('<br>')}`, allGood ? 'success' : 'error');
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            setTimeout(initManagers, 100);
        });
    </script>

    <!-- Load TravelBot modules if available -->
    <script src="location.js" onerror="console.log('location.js not found - testing without manager')"></script>
    <script src="tts.js" onerror="console.log('tts.js not found - testing without manager')"></script>
    <script src="travelbot_engine.js" onerror="console.log('travelbot_engine.js not found - testing without manager')"></script>
</body>
</html>
